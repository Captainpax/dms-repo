# ðŸ§± Base image: Pterodactyl's Python 3.10 yolk
FROM ghcr.io/pterodactyl/yolks:python_3.10

# ðŸ‘¤ Become root to install dependencies and copy files
USER root

# ðŸ“‚ Ensure the working directory exists
WORKDIR /home/container

# ðŸ“ Copy the Archipelago server files into place
COPY Archipelago/ /home/container/

# ðŸ“¦ Install Python dependencies if a requirements file is present
RUN if [ -f requirements.txt ]; then \
      python -m pip install --no-cache-dir -r requirements.txt; \
    else \
      echo "âš ï¸  requirements.txt not found, skipping dependency installation"; \
    fi

# ðŸ› ï¸ Generate the StartAP bootstrap script and ensure permissions
RUN printf '#!/bin/bash\nset -euo pipefail\ncd /home/container\nexec python3 ArchipelagoServer.py "$@"\n' > /home/container/StartAP \
    && chmod +x /home/container/StartAP \
    && chown -R 1000:1000 /home/container

# ðŸ‘¤ Drop back to the container user expected by Pterodactyl
USER 1000

# ðŸš€ Default command to launch the Archipelago server
CMD ["./StartAP"]

# ðŸ“¡ Expose the Archipelago server port
EXPOSE 3333
